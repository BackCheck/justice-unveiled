# HRPM.org Deployment Guide

## Comprehensive Deployment and Production Documentation

This guide covers deployment strategies, environment configuration, and production best practices for the HRPM platform.

---

## Table of Contents

1. [Deployment Overview](#deployment-overview)
2. [Lovable Cloud Deployment](#lovable-cloud-deployment)
3. [Environment Variables](#environment-variables)
4. [Build Process](#build-process)
5. [Edge Functions Deployment](#edge-functions-deployment)
6. [Database Migrations](#database-migrations)
7. [Storage Configuration](#storage-configuration)
8. [Domain & SSL](#domain--ssl)
9. [Monitoring & Logging](#monitoring--logging)
10. [Rollback Procedures](#rollback-procedures)

---

## Deployment Overview

### Deployment Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                   Developer Workflow                        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  Lovable Cloud Platform                      │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              Frontend Deployment                      │  │
│  │  • Automatic build on save/publish                   │  │
│  │  • CDN distribution                                  │  │
│  │  • HTTPS by default                                  │  │
│  │  • Custom domain support                             │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │           Supabase Backend Integration                │  │
│  │  • Edge Functions (auto-deploy on save)             │  │
│  │  • PostgreSQL database                               │  │
│  │  • Storage buckets                                   │  │
│  │  • Authentication                                    │  │
│  │  • Real-time subscriptions                           │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   Production Environment                     │
│                  https://hrpm.lovable.app                    │
└─────────────────────────────────────────────────────────────┘
```

### Deployment Environments

| Environment | Purpose | URL |
|-------------|---------|-----|
| **Production** | Live application | https://hrpm.lovable.app |
| **Preview** | PR/branch previews | Auto-generated URLs |
| **Local Dev** | Development | http://localhost:5173 |

---

## Lovable Cloud Deployment

### Initial Setup

1. **Connect Repository**
   - Repository is automatically connected to Lovable Cloud
   - Changes are tracked in real-time

2. **Configure Build Settings**
   - Build command: `npm run build`
   - Output directory: `dist/`
   - Node version: 18+

### Deployment Process

#### Frontend Deployment

```
Developer makes changes
        │
        ▼
Click "Publish" in Lovable UI
        │
        ▼
Lovable Cloud:
  1. Pulls latest code
  2. Installs dependencies (npm install)
  3. Runs build (npm run build)
  4. Optimizes assets
  5. Deploys to CDN
  6. Updates DNS
        │
        ▼
Live in ~2 minutes
```

**Steps:**
1. Open Lovable Cloud interface
2. Click **"Publish"** button
3. Click **"Update"** to deploy frontend changes
4. Wait for build completion (~2 minutes)
5. Verify deployment at production URL

#### Automatic Deployments

- Every save in Lovable editor triggers a preview build
- Preview URL is generated for testing
- Manual publish required for production

---

## Environment Variables

### Configuration File

**Location:** `.env` (auto-generated by Lovable)

```env
# Supabase Configuration
VITE_SUPABASE_URL=https://ccdyqmjvzzoftzbzbqlu.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=<your-anon-key>
VITE_SUPABASE_PROJECT_ID=ccdyqmjvzzoftzbzbqlu
```

### Variable Management

**⚠️ Important:**
- `.env` file is auto-generated by Lovable
- DO NOT edit manually
- DO NOT commit to version control (already in `.gitignore`)
- Variables are automatically injected during build

### Adding New Variables

1. For frontend variables:
   - Prefix with `VITE_`
   - Add to Lovable Cloud settings
   - Rebuild application

2. For Edge Functions:
   - Add via Supabase Dashboard
   - Navigate to: Settings → Edge Functions → Secrets
   - Set key-value pairs

---

## Build Process

### Local Build

```bash
# Development build
npm run dev

# Production build
npm run build

# Preview production build
npm run preview
```

### Build Output

```
dist/
├── assets/
│   ├── index-[hash].js      # Main JavaScript bundle
│   ├── index-[hash].css     # Compiled styles
│   └── [asset]-[hash].*     # Optimized images, fonts
├── index.html               # Entry HTML
└── favicon.ico              # Favicon
```

### Build Optimizations

**Vite automatically:**
- Minifies JavaScript and CSS
- Tree-shakes unused code
- Code-splits routes
- Optimizes images
- Generates source maps (production)
- Hashes assets for caching

### Build Configuration

**Location:** `vite.config.ts`

```typescript
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react-swc";
import path from "path";

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
  build: {
    target: "esnext",
    outDir: "dist",
    sourcemap: true,
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ["react", "react-dom", "react-router-dom"],
          ui: ["@radix-ui/react-dialog", "@radix-ui/react-dropdown-menu"],
          charts: ["recharts", "d3-force"],
        },
      },
    },
  },
});
```

---

## Edge Functions Deployment

### Function Structure

```
supabase/functions/
├── analyze-document/
│   ├── index.ts              # Main function file
│   └── _shared/              # Shared utilities
├── intel-chat/
│   └── index.ts
├── threat-profiler/
│   └── index.ts
└── [other-functions]/
```

### Deployment Process

**Edge Functions deploy automatically when:**
1. File is saved in Lovable editor
2. Changes are committed to repository
3. Lovable Cloud detects changes

**Manual Deployment (if needed):**

```bash
# Install Supabase CLI
npm install -g supabase

# Login
supabase login

# Deploy specific function
supabase functions deploy analyze-document

# Deploy all functions
supabase functions deploy
```

### Function Configuration

**Function Secrets:**

Set via Supabase Dashboard:
```bash
Settings → Edge Functions → Secrets
```

Add:
- `LOVABLE_AI_API_KEY` - For AI Gateway access
- `COURTLISTENER_API_KEY` - For legal precedents
- `NEWS_API_KEY` - For news fetching

### Testing Edge Functions

```bash
# Local testing
supabase functions serve analyze-document

# Test with curl
curl -i --location --request POST \
  'http://localhost:54321/functions/v1/analyze-document' \
  --header 'Authorization: Bearer YOUR_ANON_KEY' \
  --header 'Content-Type: application/json' \
  --data '{"documentContent":"test"}'
```

---

## Database Migrations

### Migration Strategy

**Lovable Cloud automatically:**
- Creates database schema on first deployment
- Applies migrations on updates
- Maintains RLS policies

### Manual Migrations (if needed)

**Via Supabase CLI:**

```bash
# Generate migration
supabase migration new add_new_table

# Edit migration file
# supabase/migrations/20240101000000_add_new_table.sql

# Apply locally
supabase db reset

# Push to production
supabase db push
```

### Migration Best Practices

1. **Always test locally first**
   ```bash
   supabase start
   supabase db reset
   ```

2. **Use transactions**
   ```sql
   BEGIN;
   -- Migration SQL
   COMMIT;
   ```

3. **Add rollback procedures**
   ```sql
   -- Up migration
   ALTER TABLE cases ADD COLUMN new_field TEXT;

   -- Down migration (in comments)
   -- ALTER TABLE cases DROP COLUMN new_field;
   ```

4. **Backup before major changes**
   - Supabase automatically backs up daily
   - Manual backup via Dashboard: Database → Backups

---

## Storage Configuration

### Storage Buckets

| Bucket | Public | Purpose |
|--------|--------|---------|
| `evidence` | Yes | Case evidence files |
| `affidavits` | Yes | Financial documents |
| `tutorials` | Yes | Tutorial videos |

### Bucket Configuration

**Via Supabase Dashboard:**

1. Navigate to: Storage → Create bucket
2. Set bucket name and public/private
3. Configure RLS policies:

```sql
-- Allow authenticated users to upload
CREATE POLICY "Authenticated users can upload"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'evidence');

-- Public read access
CREATE POLICY "Public read access"
ON storage.objects FOR SELECT
TO public
USING (bucket_id = 'evidence');
```

### File Upload Limits

- Max file size: 50MB per file
- Supported formats: PDF, DOCX, images (JPG, PNG), text files
- Storage quota: 1GB (upgradeable)

---

## Domain & SSL

### Custom Domain Setup

**Steps:**

1. **Add Domain in Lovable Cloud**
   - Navigate to Project Settings
   - Click "Add Custom Domain"
   - Enter domain name (e.g., `hrpm.org`)

2. **Configure DNS Records**

   Add CNAME record:
   ```
   Type: CNAME
   Name: @ (or www)
   Value: [provided-by-lovable].lovable.app
   TTL: 3600
   ```

3. **SSL Certificate**
   - Automatically provisioned by Lovable
   - Let's Encrypt certificate
   - Auto-renewal enabled

4. **Verification**
   - Wait for DNS propagation (up to 48 hours)
   - Certificate issued automatically
   - HTTPS enforced by default

### Domain Configuration

**Current Setup:**
- Production: `hrpm.lovable.app`
- Custom Domain: (to be configured)

---

## Monitoring & Logging

### Frontend Monitoring

**Built-in Lovable Monitoring:**
- Page load times
- Error rates
- User sessions
- Traffic analytics

**Access:**
- Lovable Dashboard → Analytics

### Backend Monitoring

**Supabase Dashboard:**

1. **Database**
   - Navigate to: Database → Logs
   - View query performance
   - Monitor connection pool

2. **Edge Functions**
   - Navigate to: Edge Functions → Logs
   - View function invocations
   - Monitor response times
   - Track errors

3. **Storage**
   - Navigate to: Storage → Usage
   - Monitor storage consumption
   - Track bandwidth usage

### Application Logs

**Edge Function Logs:**

```typescript
// In Edge Function
console.log("Processing document:", documentId);
console.error("Error analyzing:", error);

// Logs appear in Supabase Dashboard
```

**Frontend Logs:**

```typescript
// Development
console.log("Debug info:", data);

// Production (use sparingly)
if (import.meta.env.DEV) {
  console.log("Dev only:", data);
}
```

### Error Tracking

**Recommended: Add Sentry (future)**

```typescript
import * as Sentry from "@sentry/react";

Sentry.init({
  dsn: "YOUR_SENTRY_DSN",
  environment: import.meta.env.MODE,
  tracesSampleRate: 1.0,
});
```

---

## Rollback Procedures

### Frontend Rollback

**Via Lovable Cloud:**

1. Navigate to: Deployments → History
2. Select previous successful deployment
3. Click "Restore"
4. Confirm rollback

**Manual Rollback:**

```bash
# Revert to previous commit
git revert HEAD
git push

# Or reset to specific commit
git reset --hard <commit-hash>
git push --force

# Trigger new deployment
```

### Edge Function Rollback

**Via Supabase CLI:**

```bash
# List deployed functions
supabase functions list

# Deploy previous version
git checkout <previous-commit>
supabase functions deploy function-name
```

### Database Rollback

**Via Supabase Dashboard:**

1. Navigate to: Database → Backups
2. Select backup point
3. Click "Restore"
4. Confirm restoration

**⚠️ Warning:** Database rollback affects all users

### Quick Rollback Checklist

- [ ] Identify affected systems (frontend/backend/database)
- [ ] Notify users (if major rollback)
- [ ] Execute rollback procedures
- [ ] Verify system functionality
- [ ] Monitor for issues
- [ ] Document incident
- [ ] Plan fix for next deployment

---

## Production Checklist

### Pre-Deployment

- [ ] All tests passing (`npm run test`)
- [ ] Linting passed (`npm run lint`)
- [ ] Build succeeds locally (`npm run build`)
- [ ] Environment variables configured
- [ ] Edge functions tested
- [ ] Database migrations reviewed
- [ ] RLS policies verified

### Post-Deployment

- [ ] Application loads correctly
- [ ] Authentication works
- [ ] Database queries execute
- [ ] Edge functions respond
- [ ] File uploads work
- [ ] Real-time updates function
- [ ] Mobile responsive
- [ ] No console errors
- [ ] Monitor for 24 hours

### Performance Checklist

- [ ] Lighthouse score > 90
- [ ] First Contentful Paint < 2s
- [ ] Time to Interactive < 4s
- [ ] Bundle size < 500KB (gzipped)
- [ ] Images optimized
- [ ] Code split by route
- [ ] API responses < 500ms

---

## Troubleshooting

### Common Deployment Issues

**Build Fails:**
```bash
# Clear cache and rebuild
rm -rf node_modules package-lock.json
npm install
npm run build
```

**Environment Variables Not Loading:**
- Verify `.env` exists
- Check variable names have `VITE_` prefix
- Restart dev server

**Edge Functions Not Updating:**
- Check Supabase Dashboard → Edge Functions → Logs
- Verify function file saved
- Redeploy manually if needed

**Database Connection Issues:**
- Check Supabase project status
- Verify RLS policies
- Check connection pool limits

**CORS Errors:**
- Verify Supabase URL in `.env`
- Check API key permissions
- Review RLS policies

---

*For additional deployment support, contact Lovable Cloud support or refer to the [Supabase Documentation](https://supabase.com/docs).*
